include:
  - template: Security/Container-Scanning.gitlab-ci.yml


container_scanning:
  rules:
    - if: '$GITLAB_CONTAINER_SCAN_DISABLED == "true"'
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $CI_GITLAB_FIPS_MODE == "true" &&
          $CS_ANALYZER_IMAGE !~ /-(fips|ubi)\z/
      variables:
        CS_IMAGE_SUFFIX: -fips
    - if: $CI_COMMIT_BRANCH
    - if: '$SAFESCARF_NOT_ON_MASTER == "true" && $CI_COMMIT_BRANCH == "master"'
      when: never

container_scanning_upload_container:
  extends: .safescarf_upload
  needs: ["safescarf_create_engagement", "container_scanning"]
  variables:
    SAFESCARF_SCAN_TYPE: "GitLab Container Scan"
    SAFESCARF_SCAN_TEST_TYPE: "GitLab-CI Container Scan"
    SAFESCARF_SCAN_FILE: "./gl-container-scanning-report.json"
  rules:
    - if: '$GITLAB_CONTAINER_SCAN_DISABLED == "true"'
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $CI_GITLAB_FIPS_MODE == "true" &&
          $CS_ANALYZER_IMAGE !~ /-(fips|ubi)\z/
      variables:
        CS_IMAGE_SUFFIX: -fips
    - if: $CI_COMMIT_BRANCH
    - if: '$SAFESCARF_NOT_ON_MASTER == "true" && $CI_COMMIT_BRANCH == "master"'
      when: never

  

container_scanning_upload_dependency:
  extends: .safescarf_upload
  needs: ["safescarf_create_engagement", "container_scanning"]
  variables:
    SAFESCARF_SCAN_TYPE: "GitLab Dependency Scanning Report"
    SAFESCARF_SCAN_TEST_TYPE: "GitLab-CI Container Dependency"
    SAFESCARF_SCAN_FILE: "./gl-dependency-scanning-report.json"
  rules:
    - if: '$GITLAB_CONTAINER_SCAN_DISABLED == "true"'
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $CI_GITLAB_FIPS_MODE == "true" &&
          $CS_ANALYZER_IMAGE !~ /-(fips|ubi)\z/
      variables:
        CS_IMAGE_SUFFIX: -fips
    - if: $CI_COMMIT_BRANCH
    - if: '$SAFESCARF_NOT_ON_MASTER == "true" && $CI_COMMIT_BRANCH == "master"'
      when: never
