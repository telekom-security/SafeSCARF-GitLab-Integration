include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml

# Extend GitLab SAST job to publish the report file as artifact to be used by other jobs
#dependency_scanning:
#  artifacts:
#    paths: 
#      - "gl-dependency-scanning-report.json"
#      - "**/gl-sbom-*.cdx.json"

# needed because it would override config above
.cyclonedx-reports:
  artifacts:
    paths:
      - "**/gl-sbom-*.cdx.json"
      - "gl-dependency-scanning-report.json"

gemnasium-safescarf:
  extends: .safescarf_upload
  needs: ["safescarf_create_engagement", "gemnasium-dependency_scanning"]
  variables:
    SAFESCARF_SCAN_TYPE: "GitLab Dependency Scanning Report"
    SAFESCARF_SCAN_TEST_TYPE: "GitLab-CI Gemnasium"
    SAFESCARF_SCAN_FILE: "./gl-dependency-scanning-report.json"
  rules:
    - if: '$SAFESCARF_NOT_ON_MASTER == "true" && $CI_COMMIT_BRANCH == "master"'
      when: never
    - if: $DEPENDENCY_SCANNING_DISABLED
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/ &&
          $CI_GITLAB_FIPS_MODE == "true"
      exists: !reference [.gemnasium-shared-rule, exists]
      variables:
        DS_IMAGE_SUFFIX: "-fips"
        DS_REMEDIATE: "false"
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/
      exists: !reference [.gemnasium-shared-rule, exists]


gemnasium-maven-safescarf:
  extends: .safescarf_upload
  needs: ["safescarf_create_engagement", "gemnasium-maven-dependency_scanning"]
  variables:
    SAFESCARF_SCAN_TYPE: "GitLab Dependency Scanning Report"
    SAFESCARF_SCAN_TEST_TYPE: "GitLab-CI Gemnasium Maven"
    SAFESCARF_SCAN_FILE: "./gl-dependency-scanning-report.json"
  rules:
    - if: '$SAFESCARF_NOT_ON_MASTER == "true" && $CI_COMMIT_BRANCH == "master"'
      when: never
      - if: $DEPENDENCY_SCANNING_DISABLED
      when: never
    - if: $DS_EXCLUDED_ANALYZERS =~ /gemnasium-maven/
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/ &&
          $CI_GITLAB_FIPS_MODE == "true"
      exists: !reference [.gemnasium-maven-shared-rule, exists]
      variables:
        DS_IMAGE_SUFFIX: "-fips"
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/
      exists: !reference [.gemnasium-maven-shared-rule, exists]


gemnasium-python-safescarf:
  extends: .safescarf_upload
  needs: ["safescarf_create_engagement", "gemnasium-python-dependency_scanning"]
  variables:
    SAFESCARF_SCAN_TYPE: "GitLab Dependency Scanning Report"
    SAFESCARF_SCAN_TEST_TYPE: "GitLab-CI Gemnasium Python"
    SAFESCARF_SCAN_FILE: "./gl-dependency-scanning-report.json"
  rules:
    - if: '$SAFESCARF_NOT_ON_MASTER == "true" && $CI_COMMIT_BRANCH == "master"'
      when: never
    - if: $DEPENDENCY_SCANNING_DISABLED
      when: never
    - if: $DS_EXCLUDED_ANALYZERS =~ /gemnasium-python/
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/ &&
          $CI_GITLAB_FIPS_MODE == "true"
      exists: !reference [.gemnasium-python-shared-rule, exists]
      variables:
        DS_IMAGE_SUFFIX: "-fips"
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/
      exists: !reference [.gemnasium-python-shared-rule, exists]
    # Support passing of $PIP_REQUIREMENTS_FILE
    # See https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#configuring-specific-analyzers-used-by-dependency-scanning
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/ &&
          $PIP_REQUIREMENTS_FILE &&
          $CI_GITLAB_FIPS_MODE == "true"
      variables:
        DS_IMAGE_SUFFIX: "-fips"
    - if: $CI_COMMIT_BRANCH &&
          $GITLAB_FEATURES =~ /\bdependency_scanning\b/ &&
          $PIP_REQUIREMENTS_FILE
